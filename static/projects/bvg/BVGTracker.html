<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Bus 142 & 123 near HBF (3 km radius)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Helvetica Neue", Arial, sans-serif;
      background: #f4f6f8;
      color: #333;
    }

    .header {
      text-align: center;
      padding: 20px 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header h1 {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 600;
      color: #1a1a1a;
    }

    .header p {
      margin: 6px 0 0 0;
      font-size: 0.95rem;
      color: #555;
    }

    #map {
      height: calc(100vh - 110px);
      width: 100vw;
    }

    @media (max-width: 600px) {
      .header h1 {
        font-size: 1.3rem;
      }
      #map {
        height: calc(100vh - 100px);
      }
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>Bus 142 & 123 Real-time Map</h1>
    <p>Within 3 km of HBF, SOURCE: BVG, UPDATE: every 10s</p>
  </div>

  <div id="map"></div>


  <script>
    // Coordinates
    const poststadionLat = 52.530282;
    const poststadionLon = 13.362429;
    const leopoldLat = 52.54638;
    const leopoldLon = 13.35917;

    // Initialise the map centred on HBF
    var map = L.map('map').setView([poststadionLat, poststadionLon], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Blue dot marker for Leopoldplatz and other stations
    const dotIcon = L.divIcon({
      html: '<div style="width:12px;height:12px;background-color:blue;border-radius:50%;"></div>',
      className: '',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });
	L.marker([poststadionLat, poststadionLon], { icon: dotIcon })
      .addTo(map)
      .bindPopup('Poststadion');
    L.marker([leopoldLat, leopoldLon], { icon: dotIcon })
      .addTo(map)
      .bindPopup('Leopoldplatz');

    // Store markers by tripId
    var markers = {};

    async function updateBuses() {
      try {
        // 3 km radius bounding box
        const north = poststadionLat + 0.027027;
        const south = poststadionLat - 0.027027;
        const east  = poststadionLon + 0.044427;
        const west  = poststadionLon - 0.044427;

        const url = 'https://v6.bvg.transport.rest/radar'
          + '?north=' + north.toFixed(6)
          + '&west=' + west.toFixed(6)
          + '&south=' + south.toFixed(6)
          + '&east=' + east.toFixed(6)
          + '&results=256'
          + '&duration=60'
          + '&frames=3';

        const res = await fetch(url);
        const data = await res.json();

        // Filter for bus lines 142 and 123
        const buses = data.movements.filter(m =>
          m.line && m.line.product === 'bus' && (m.line.name === '142' || m.line.name === '123')
        );

        buses.forEach(bus => {
          const id = bus.tripId;
          const pos = [bus.location.latitude, bus.location.longitude];

          // Compute heading angle for arrow rotation
          let angleDeg = 0;
          if (bus.frames && bus.frames.length > 0) {
            const frame = bus.frames[0];
            if (frame.origin && frame.origin.location && frame.destination && frame.destination.location) {
              const o = frame.origin.location;
              const d = frame.destination.location;
              const deltaLat = d.latitude - o.latitude;
              const deltaLon = d.longitude - o.longitude;
              const angleRad = Math.atan2(deltaLon, deltaLat);
              angleDeg = angleRad * 180 / Math.PI;
            }
          }

          // Determine line name and destination
          const lineName = bus.line && bus.line.name ? bus.line.name : '';
          const terminal = bus.direction || '';

          // Determine arrow colour: red for 123→Hbf or 142→Ostbahnhof, else green
          let arrowColor = 'green';
          const dirLower = terminal.toLowerCase();
          if ((lineName === '123' && (dirLower.includes('hbf') || dirLower.includes('hauptbahnhof')))
            || (lineName === '142' && dirLower.includes('ostbahnhof'))) {
            arrowColor = 'red';
          }

          // Parse next stop from nextStopovers[2]
          let nextStopName = '';
          let nextArrTime = '';
          let delayMinutes = null;
          let nextStopover = null;

          if (bus.nextStopovers && bus.nextStopovers.length > 2) {
            nextStopover = bus.nextStopovers[2];
          } else if (bus.nextStopovers && bus.nextStopovers.length > 1) {
            nextStopover = bus.nextStopovers[1];
          } else if (bus.nextStopovers && bus.nextStopovers.length > 0) {
            nextStopover = bus.nextStopovers[0];
          }
          if (nextStopover) {
            if (nextStopover.stop && nextStopover.stop.name) {
              nextStopName = nextStopover.stop.name;
            }
            let timeStr = nextStopover.arrival || nextStopover.plannedArrival || nextStopover.departure || nextStopover.plannedDeparture || '';
            if (timeStr) {
              try {
                const date = new Date(timeStr);
                nextArrTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
              } catch (e) {
                nextArrTime = timeStr;
              }
            }
            const delaySec = nextStopover.arrivalDelay != null ? nextStopover.arrivalDelay : nextStopover.departureDelay;
            if (delaySec != null) {
              delayMinutes = Math.round(delaySec / 60);
            }
          }

          // Create arrow marker HTML: narrow arrow (smaller width) with line and destination
          const arrowHtml = `
            <div style="text-align:center;">
              <div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:20px solid ${arrowColor};transform: rotate(${angleDeg}deg);margin:auto;"></div>
              <div style="font-size:12px;font-weight:bold;line-height:1em;white-space:nowrap;">${lineName}</div>
              <div style="font-size:10px;max-width:80px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${terminal}</div>
            </div>
          `;
          const icon = L.divIcon({
            html: arrowHtml,
            className: '',
            iconSize: [80, 60],
            iconAnchor: [40, 30]
          });

          // Popup content (English)
          const popupContent =
            `<strong>Line:</strong> ${lineName}<br>` +
            `<strong>Destination:</strong> ${terminal || '–'}<br>` +
            `<strong>Next stop:</strong> ${nextStopName || '–'}<br>` +
            `<strong>ETA:</strong> ${nextArrTime || '–'}<br>` +
            `<strong>Delay:</strong> ${delayMinutes != null ? delayMinutes + ' min' : '–'}`;

          if (markers[id]) {
            markers[id].setLatLng(pos);
            markers[id].setIcon(icon);
            markers[id].getPopup().setContent(popupContent);
          } else {
            markers[id] = L.marker(pos, { icon: icon }).addTo(map)
              .bindPopup(popupContent);
          }
        });

        // Remove markers for buses no longer in area
        for (const id in markers) {
          if (!buses.find(b => b.tripId === id)) {
            map.removeLayer(markers[id]);
            delete markers[id];
          }
        }
      } catch (e) {
        console.error('Failed to fetch bus positions:', e);
      }
    }

    updateBuses();
    setInterval(updateBuses, 10000);
  </script>
</body>
</html>
